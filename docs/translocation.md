# 异位处理记录



![image-20220715102318499](https://s2.loli.net/2022/07/15/Zm7Lr1Q4CtD8ivX.png)



## 步骤

1. 检测到异位，并返回异位位置  > `error_box.py`
2. 查询该位置，所包含的ctg信息   > `find_error_ctgs.py`
3. 对ctg进行切割，更新assembly信息  > `cut_ctg.py`
4. **查找易位需要插入的位置，并修改assembly信息**   > `search_right_site.py`
5. 3D-DNA测试





![image-20220715101207736](https://s2.loli.net/2022/07/15/J6KOMukIWe2iqV4.png)





## *矩阵获取

> Notes!

```python
matrix_object_chr = hic.getMatrixZoomData('assembly', 'assembly', "observed", "KR", "BP", 1250000)
# 上面代码，会根据分辨率，直接在基因组长度上，进行切割，形成一个整体的矩阵

numpy_matrix_chr_1 = matrix_object_chr.getRecordsAsMatrix(453010131, 455241282, 0, 1)
# 这条代码会根据查炸的范围，从整体的矩阵中提取包括这个范围的矩阵
```



​		获取真实矩阵的方案：由于直接用位点查询的矩阵，会存在许多0的问题，因此，需要根据分辨率和位点，进行结合，获取真实矩阵bin的位置。用于后续查找峰值





## *插入位置的确定

​		将上面获取的矩阵，转化为图像的形式，获取峰值，峰值除开原本位置，就是需要插入的位置，利用这个峰值所在的bin，获取插入的区间，再寻找contig，进行整合插入。

​		峰值需要根据多个一维的情况，先删除原本的峰值，再取交集。





## *插入位置精确

​		从各个分辨率进行进行查找插入位置，直到返回位置为一个ctg时，就结束查找

​		其中，最大峰值的确定，应该为每一行矩阵中护在程度对大的点对应的index，取交集，如果没有交集就平均取整，插入到中间。





## *assembly调整

​		如何调整assembly文件

1. 首先切开要调整的ctg，更新assembly文件的顺序
2. 寻找需要插入的位置的ctg的编号
3. 将原本的ctg组，放置在插入ctg的后面即可









## *多个错误同步

​		本流程基于两个错误之间没有交集

> 将assembly 放入内存，时时更新



### 流程

1. Model 返回 错误的字典

```sh
errors = {
	"1" : (a, b),
	"2" : (c, d),
	"3" : (e, f)
}

# 字母代表起始与终止的位置
```



2. 查找该区域内的ctgs > `find_site_ctgs.py`



3. 对这些ctgs进行切割 > `cut_ctgs.py`



4. 查找插入位置，对assembly进行修改 > `search_right_site.py`



5. 由上一步返回的区间，获得需要插入的ctg名字





## Examples

- 453010131-455241282

```sh
错误位点
	start_site = 453010131
	end_site = 455241282

	length = 2231151


	ratio ： 2
	查询位点为 ： 906020262 - 910482564 



寻找插入位置 > find_error_ctgs
	分辨率为： 1250000
	错误区间的真实范围为：452500000 - 455000000 
	错误区间的bin范围为：362 - 364 

	第0个矩阵的峰值点信息：
	index：[362 445]
	value：[168680.21875    23951.6015625] 

	第1个矩阵的峰值点信息：
	index：[363 423 445]
	value：[220267.921875     2342.76049805  28911.31640625] 

	第2个矩阵的峰值点信息：
	index：[364 445]
	value：[167277.46875      7475.10546875] 

	交集最多的index为：445
	应该插入区间为：556250000 - 557500000


错误位点包含的ctg
	分辨率：1250000
	查询位点为 ： 1112500000 - 1115000000 
	该区域包含的contig : 
	{
	    ">utg9500": {
	        "length": "496038",
	        "start": 1112238043,
	        "end": 1112734081
	    },
	    ">utg3019": {
	        "length": "780826",
	        "start": 1112734081,
	        "end": 1113514907
	    },
	    ">utg28760": {
	        "length": "236856",
	        "start": 1113514907,
	        "end": 1113751763
	    },
	    ">utg101869": {
	        "length": "37527",
	        "start": 1113751763,
	        "end": 1113789290
	    },
	    ">utg196": {
	        "length": "609885",
	        "start": 1113789290,
	        "end": 1114399175
	    },
	    ">utg57036": {
	        "length": "49321",
	        "start": 1114399175,
	        "end": 1114448496
	    },
	    ">utg1331": {
	        "length": "3174618",
	        "start": 1114448496,
	        "end": 1117623114
	    }
	}


精确位点
	分辨率： 500000
	查询位点为 ： 1114000000 - 1115000000 
	该区域包含的contig : 
	{
	    ">utg196": {
	        "length": "609885",
	        "start": 1113789290,
	        "end": 1114399175
	    },
	    ">utg57036": {
	        "length": "49321",
	        "start": 1114399175,
	        "end": 1114448496
	    },
	    ">utg1331": {
	        "length": "3174618",
	        "start": 1114448496,
	        "end": 1117623114
	    }
	}
```





- 495140001-499424992

```sh
错误位点
	start_site = 495140001
	end_site = 499424992

	length = 4284991


	ratio ： 2
	查询位点为 ： 990280002 - 998849984 
    
    
分辨率为： 500000
错误区间的真实范围为：495000000 - 499500000 
错误区间的bin范围为：990 - 999 

第0个矩阵的峰值点信息：
index：[837 990]
value：[ 8376.85742188 47682.78515625] 

第1个矩阵的峰值点信息：
index：[837 991]
value：[ 8759.53027344 65901.1953125 ] 

第2个矩阵的峰值点信息：
index：[837 992]
value：[ 7098.46972656 58406.953125  ] 

第3个矩阵的峰值点信息：
index：[837 993]
value：[ 5385.01513672 56680.04296875] 

第4个矩阵的峰值点信息：
index：[841 994]
value：[ 4378.74951172 59296.61328125] 

第5个矩阵的峰值点信息：
index：[840 995]
value：[ 5222.49755859 65661.90625   ] 

第6个矩阵的峰值点信息：
index：[840 996]
value：[ 6195.22363281 62576.3125    ] 

第7个矩阵的峰值点信息：
index：[840 997]
value：[ 9053.27832031 60638.71484375] 

第8个矩阵的峰值点信息：
index：[839 998]
value：[ 8549.859375  70268.9921875] 

第9个矩阵的峰值点信息：
index：[999]
value：[65909.9375] 

交集最多的index为：837
应该插入区间为：418500000 - 419000000

>  应该插入到utg1201

把序列调整到utg1201后即可


```









## find_peaks

```python
from scipy.signal import find_peaks

x = np.arange(0, 917)
y = numpy_matrix_chr_1[2]

# 已导入需要处理的数据(x,y)
plt.plot(x,y)
plt.xlabel('freq/Hz')
plt.ylabel('amp')

peak_id,peak_property = find_peaks(y, height=2000, distance=20)
peak_freq = x[peak_id]
peak_height = peak_property['peak_heights']
print('peak_freq',peak_freq)
print('peak_height',peak_height)

```





## search_right_site_V2

​		多分辨率下查找插入位点， 返回值为要插入的ctg名字

​		从上一次返回的区间信息，查找下一个

​		如果返回的区间，通过查找只有一个ctg，就终止查找

​		负责就进行下一个分辨率的查找，此次查找不需要再去除原本位置，只需要拿到最高互组点即可

```python
```



